# 1. Метод создания ТИ

**POST** `api/v1/measpoints/{measpointId}`  

**Описание:**  
Данный метод предназначен для создания точки измерения.

---

## Логика метода

При вызове метода необходимо выполнить следующую последовательность действий.

---

### Проверки

1. Проверить заполнение обязательных полей  
   - Если обязательные поля не заполнены, выводить ошибку:  
     **«Заполните обязательные поля: наименование поля»**

2. Проверить, что значение `range_value_min < range_value_max`  
   - В противном случае выводить ошибку:  
     **«Неверно введён диапазон»**

3. Проверить, существует ли запись в таблице `CHARACTERISTIC`, где  
   - `CHARACTERISTIC/id == char_id`, переданному на вход  
   - Если запись отсутствует, выводить ошибку:  
     **«Признак с номером №(n) отсутствует в справочнике»**

### Запись в таблицу `MEAS_POINTS`

4. В таблицу `MEAS_POINTS` записать следующие значения:

4.1. `id` — генерируется последовательно автоматически  

4.2. `name` — входное значение `measpoint_name`  

4.3. `description` — входное значение `description`  

4.4. `first_value` — первоначальное значение  

4.5. `range_value_min` — входное значение `range_value_min`  

4.6. `range_value_max` — входное значение `range_value_max`  

4.7. `annual_value` — входное значение `annual`  

4.8. `is_counter` — входное значение `counter` (`false` или `true`)  

4.9. `characteristic` — входное значение `char_id`

---

### Генерация первого документа измерения

5. При заполнении поля `first_value` необходимо сгенерировать первый документ измерения.  

В таблицу `MEAS_DOCS` записать:

5.1. `id` — генерируется последовательно автоматически  

5.2. `meas_points` — передать значение из поля `id` таблицы `MEAS_POINTS`  

5.3. `date` — передать текущую дату  

5.4. `text` — `null`  

5.5. `value` — передать входное значение `first_value`  

5.6. `unit_of_measure` — в таблице `CHARACTERISTIC` смотреть значения по полю `id == char_id`, переданному на вход. Передать значение из `CHARACTERISTIC/unit_of_measure`  

5.7. `is_deleted` — `false`  

5.8. `id_creator` — получить значение из токена авторизации  

5.9. `source` — подставлять значение в зависимости от того, откуда формимруем ДИ **«MOB»** - если с мобильного приложения, **«WEB»** - если с веб приложения



# 2. Метод получения списка ТИ

**GET** `api/v1/measpoints`  

**Описание:**  
Данный метод предназначен для получения списка точек измерения.  

---

## Таблица `meas_points_t`

| Название       | Тип данных  | Комментарий           | Обязательность |
|----------------|------------|----------------------|----------------|
| id             | int8       | id записи             |                |
| id_operation   | int8       | id операции           | да             |
| id_measpoint   | int8       | id точки измерения    | да             |
| create_date    | timestamp  | Дата и время создания|                |

---

## Схема запроса

GET api/v1/measpoints

Входные параметры 
| №   | Имя     | Тип | Обязательное | Описание                                         |
| --- | ------- | --- | ------------ | ------------------------------------------------ |
| 1.1 | equipId | int | да           | Id оборудования, на которое ищем точки измерения |
| 1.2 | unitId  | int | нет          | Идентификатор единицы измерения                  |

Выходные параметры
| №    | Имя                | Тип    | Описание                                |
| ---- | ------------------ | ------ | --------------------------------------- |
| 1.1  | id                 | int    | Id точки измерения                      |
| 1.2  | measpoint_name     | string | Наименование точки измерения            |
| 1.3  | char_id            | int    | Id признака                             |
| 1.4  | char_name          | string | Техническое наименование признака       |
| 1.5  | char_text          | string | Текстовое наименование признака         |
| 1.6  | charUnitId         | int    | Id единицы измерения признака           |
| 1.7  | charUnitName       | string | Наименование единицы измерения признака |
| 1.8  | last_measure_date  | date   | Дата последнего измерения               |
| 1.9  | last_measure_value | string | Значение последнего измерения           |
| 1.10 | errorDescription   | string | Описание ошибки                         |


Логика метода

При вызове метода выполняется следующая последовательность действий:

Проверить входные параметры

1.1. Если значение не заполнено → вывести ошибку: «Не заполнен код оборудования»

1.2. Если значение заполнено → переход к п.2

2. Выбрать значения из таблицы MEAS_POINTS где:

2.1. MEAS_POINTS/EQUIPMENTS == входному значению equipId

2.2. MEAS_POINTS/is_deleted == false

3. Вернуть значения:

3.1. `id` — `MEAS_POINTS/id`

3.2. `measpoint_name` — `MEAS_POINTS/name`

3.3. `char_id` — `MEAS_POINTS/characteristic`

3.4. `char_name` — `CHARACTERISTIC/name`

3.5. `char_text` — `CHARACTERISTIC/text`

3.6. `charUnitId` — `CHARACTERISTIC/unit_of_measure`

# 3. Метод получения ТИ

**GET** `api/v1/measpoints/{measpointId}`  

**Описание:**  
Данный метод предназначен для получения информации о конкретной точки измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя          | Тип    | Обязательное | Описание |
|-----|--------------|--------|--------------|----------|
| 1.1 | measpointId  | int    | да           | Id точки измерения |
| 1.2 | lang         | string | нет          | Язык, передаем RU |

---

### Выходные параметры

| №    | Имя              | Тип    | Обязательное | Описание |
|------|------------------|--------|--------------|----------|
| 1.1  | id               | int    | да           | Id точки измерения |
| 1.2  | measpoint_name   | string | да           | Наименование точки измерения |
| 1.3  | char_id          | int    | да           | Id признака |
| 1.4  | char_name        | string | да           | Техническое наименование признака |
| 1.5  | charUnitId       | int    | да           | Id единицы измерения признака |
| 1.6  | charUnitName     | string | нет          | Наименование единицы измерения признака |
| 1.7  | description      | string | нет          | Описание к точке измерения |
| 1.8  | range_value_min  | string | нет          | Минимальное значение диапазона |
| 1.9  | range_value_max  | string | нет          | Максимальное значение диапазона |
| 1.10 | annual_value     | string | нет          | Среднее значение по точке измерения за год |
| 1.11 | errorDescription | string | нет          | Описание ошибки |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий:

1. Проверить входные параметры  
   1.1. Если значение `measpointId` не заполнено, то выводить ошибку  
   **«Не заполнен код точки измерения»**  
   1.2. Если значение заполнено, то переходить к п. 2  

2. Выбрать значения из таблицы `MEAS_POINTS`, где  
   `MEAS_POINTS/id == входному значению measpointId`  
   - Если значение не найдено, то выводить ошибку  
     **«Точка измерения с № (n) не найдена»**

3. Вернуть значения:  

   3.1. `id` — `MEAS_POINTS/id`  

   3.2. `measpoint_name` — `MEAS_POINTS/name`  

   3.3. `char_id` — `MEAS_POINTS/characteristic`, где  
   `CHARACTERISTIC/id == MEAS_POINTS/characteristic`  

   3.4. `char_name` — `CHARACTERISTIC/name`, где  
   `CHARACTERISTIC/id == MEAS_POINTS/characteristic`  

   3.5. `char_text` — `CHARACTERISTIC/text`, где  
   `CHARACTERISTIC/id == MEAS_POINTS/characteristic`  

   3.6. `charUnitId` — `CHARACTERISTIC/unit_of_measure`, где  
   `CHARACTERISTIC/id == MEAS_POINTS/characteristic`  

   3.7. `charUnitName` — смотреть `UNITS_T/short_name`, для которых  
   `UNITS_T/unit_id == CHARACTERISTIC/unit_of_measure` из п. 3.6  

   3.8. `description` — `MEAS_POINTS/description`  

   3.9. `range_value_min` — `MEAS_POINTS/range_value_min`  

   3.10. `range_value_max` — `MEAS_POINTS/range_value_max`  

   3.11. `annual_value` — `MEAS_POINTS/annual`


# 4. Метод для редактирования ТИ

**PATCH** `api/v1/measpoints/{measpointId}`  

**Описание:**  
Данный метод предназначен для редактирования точки измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя              | Тип    | Обязательное | Описание |
|-----|------------------|--------|--------------|----------|
| 1.1 | measpointId      | int    | да           | Id ТИ, которую редактируем |
| 1.2 | measpoint_name   | string | да           | Наименование точки измерения |
| 1.3 | char_id          | int    | да           | Id признака |
| 1.4 | counter          | bool   | нет          | Обозначение типа точки измерения – счетчик |
| 1.5 | first_value      | string | нет          | Первоначальное значение по точке измерения (заполняется только при создании) |
| 1.6 | description      | string | нет          | Описание к точке измерения |
| 1.7 | range_value_min  | string | нет          | Минимальное значение диапазона |
| 1.8 | range_value_max  | string | нет          | Максимальное значение диапазона |
| 1.9 | annual_value     | string | нет          | Среднее значение по точке измерения за год |

---

### Выходные параметры

| №   | Имя              | Тип    | Обязательное | Описание |
|-----|------------------|--------|--------------|----------|
| 1.1 | measpointId      | int    | да           | Id точки измерения |
| 1.2 | errorDescription | string | нет          | Описание ошибки |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий.

### Проверки

1. Проверить входные параметры  
   1.1. Если значение `measpointId` не заполнено, то выводить ошибку  
   **«Не заполнен код точки измерения»**  
   1.2. Если значение заполнено, то переходить к п. 2  

2. Проверить, существует ли в таблице `MEAS_POINTS` запись, где  
   `MEAS_POINTS/id == measpointId`, поданному на вход  
   - В противном случае выводить ошибку  
     **«Точка измерения с номером n не найдена»**

3. Проверить, что значение `range_value_min < range_value_max`  
   - В противном случае выводить ошибку  
     **«Неверно введён диапазон»**

4. Проверить, существует ли запись в таблице `CHARACTERISTIC`, где  
   `CHARACTERISTIC/id == char_id`, поданному на вход  
   - В противном случае выводить ошибку  
     **«Признак с номером №(n) отсутствует в справочнике»**

---

### Обновление данных в таблице `MEAS_POINTS`

5. В таблицу `MEAS_POINTS` записать измененные поля:

5.1. `name` — входное значение `measpoint_name`  

5.2. `description` — входное значение `description`  

5.3. `range_value_min` — входное значение `range_value_min`  

5.4. `range_value_max` — входное значение `range_value_max`  

5.5. `annual_value` — входное значение `annual`  

5.6. `is_counter` — входное значение `counter` (`false` или `true`)  

5.7. `characteristic` — входное значение `char_id`


# 5. Метод удаления ТИ

**DELETE** `api/v1/measpoints/{measpointId}`  

**Описание:**  
Данный метод предназначен для удаления точки измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя          | Тип | Обязательное | Описание |
|-----|--------------|-----|--------------|----------|
| 1.1 | measpoint_id | int | да           | Id ТИ |
| 1.2 | id_deleter   | int | да           | Id пользователя, удалившего ТИ |

---

### Выходные параметры

| №   | Имя              | Тип    | Обязательное | Описание |
|-----|------------------|--------|--------------|----------|
| 1.1 | measpointId      | int    | да           | Id точки измерения |
| 1.2 | errorDescription | string | нет          | Описание ошибки |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий.

### Проверки

1. Проверить входные параметры  
   1.1. Если значение `measpointId` не заполнено, то выводить ошибку  
   **«Не заполнен код точки измерения»**  
   1.2. Если значение заполнено, то переходить к п. 2  

2. Проверить, существует ли в таблице `MEAS_POINTS` запись, где  
   `MEAS_POINTS/id == measpointId`, поданному на вход  
   - В противном случае выводить ошибку  
     **«Точка измерения с номером n не найдена»**

3. Проверить, есть ли записи в таблице `OPERATIONS_MEAS_POINTS`, где  
   `OPERATIONS_MEAS_POINTS/meas_point_id == measpoint_id`, поданному на вход  

   3.1. Если записей нет, то переходить к п. 5  

   3.2. Если записи есть, то переходить к п. 4  

4. В строке, найденной в п. 3, выполнить следующие действия:

   4.1. Найти и запомнить значение `operation_id`  

   4.2. Запомнить значение `OPERATIONS/order_id`, где  
   `OPERATIONS/id == operation_id`, найденному в п. 4.1  

   4.3. Проверить значение `ORDERS/status_id`, где  
   `ORDERS/id == order_id`, найденному в п. 4.2  

   - Если `status_id != 4` или `status_id != 6`, то выводить ошибку  
     **«По данной точке измерения есть активные заказы»**  
   - В противном случае переходить к п. 5  

---

### Логическое удаление точки измерения

5. В таблице `MEAS_POINTS` для записи, где  
   `MEAS_POINTS/id == measpointId`, поданному на вход, записать:

5.1. `id` — входное значение `measpoint_id`  

5.2. `id_deleter` — входное значение `id_deleter`  

5.3. `deletion_date` — сохранить текущую дату на стороне сервера  

5.4. `is_deleted` — `true`


# 6. Метод создания ДИ

**POST** `api/v1/measdocs/{measdocsId}`  

**Описание:**  
Данный метод предназначен для создания документа измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя               | Тип    | Обязательное | Описание |
|-----|-------------------|--------|--------------|----------|
| 1.1 | meas_point        | int    | да           | Id ТИ |
| 1.2 | text              | string | нет          | Текст ДИ |
| 1.3 | date              | date   | да           | Дата и время создания ДИ |
| 1.4 | availableValueId  | int    | нет          |  |
| 1.5 | value             | string | нет          | Значение измерения |
| 1.6 | unitOfMeasureId   | int    | да           | Id единицы измерения |
| 1.7 | creator           | int    |              | Id пользователя, создавшего ДИ |
| 1.8 | source            | string | да           | Источник ДИ |

---

### Выходные параметры

| №   | Имя              | Тип    | Описание |
|-----|------------------|--------|----------|
| 1.1 | id               | int    | Id документа измерения |
| 1.2 | errorDescription | string | Описание ошибки |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий.

### Проверки

1. Проверить заполнение обязательных полей  
   - Если обязательные поля не заполнены, то выводить ошибку  
     **«Заполните обязательные поля»**

2. Проверить входное значение `availableValueId`:

   2.1. Если значение `availableValueId` заполнено, то выполнять пункты **3 – 3.10**,  
   **кроме п. 3.6**

   2.2. Если значение `availableValueId` не заполнено, то выполнять пункты **3 – 3.10**,  
   **кроме п. 3.5**

---

### Создание документа измерения

3. В таблицу `MEAS_DOCS` записать следующие значения:

3.1. `id` — генерируется последовательно автоматически  

3.2. `meas_points` — передать значение из поля `id` для ТИ, которая была указана в операции внутри заказа  

3.3. `date` — сохранить текущую дату на стороне сервера с учетом часового пояса  

3.4. `text` — `null` или передать текст, введенный в поле для ввода  

3.5. `value` — передать входное значение `value`  

3.6. `value` — найти по входному значению `availableValueId` в таблице  
`CHARACTERISTICS_AVAILABLE_VALUES/value` и передать найденное значение  

3.7. `unitOfMeasureId` — передать значение из поля `unitOfMeasureId`  
для параметра ТИ, которая была указана в операции внутри заказа в массиве `measpoints`  

3.8. `is_deleted` — на стороне сервера всегда `false` в данном методе  

3.9. `id_creator` — получить значение из токена авторизации  

3.10. `source` — заполняется в зависимости от того, с какого ресурса был создан ДИ:  
- если создано из МП — `MOB`  
- если создано из WEB — `WEB`


# 7. Метод получения ДИ

**GET** `api/v1/measdocs/{meas_point}`

**Описание:**  
Данный метод предназначен для получения документов измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя        | Тип    | Обязательное | Описание |
|-----|------------|--------|--------------|----------|
| 1.1 | meas_point | int    | да           | Id ТИ |
| 1.2 | lang       | string |              | Язык, передаем `RU` |

---

### Выходные параметры

| №    | Имя                | Тип    | Описание |
|------|--------------------|--------|----------|
| 1.1  | measdocs           | array  | Массив документов измерения |
| 1.2  | text               | string | Текст ДИ |
| 1.3  | date               | date   | Дата создания ДИ |
| 1.4  | id                 | int    | Id (номер) документа измерения |
| 1.5  | value              | string | Значение измерения |
| 1.6  | unitOfMeasureId    | int    | Id единицы измерения |
| 1.7  | unitOfMeasureName  | string | Наименование единицы измерения |
| 1.8  | creator_id         | int    | Id пользователя, создавшего ДИ |
| 1.9  | creatorName        | string | ФИО пользователя, создавшего ДИ |
| 1.10 | source             | string | Источник ДИ |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий.

1. Проверить входные параметры.

   1.1. Если значение `meas_point` не заполнено, то выводить ошибку  
   **«Не заполнен код точки измерения»**

   1.2. Если значение заполнено, то переходить к п. 2

2. Выбрать значения из таблицы `MEAS_POINTS`, где  
   `MEAS_POINTS/id ==` входному значению `meas_point`.  

   Если значение не найдено, то выводить ошибку  
   **«Точка измерения с № (n) не найдена»**

3. Выбрать значения из таблицы `MEAS_DOCS`, где  
   `MEAS_DOCS/meas_points == id`, найденному в п. 2

4. Вернуть значения в массиве `meas_docs`:

4.1. `text` — `MEAS_DOCS/text`  

4.2. `date` — `MEAS_DOCS/date`  

4.3. `id` — `MEAS_DOCS/id`  

4.4. `value` — `MEAS_DOCS/value`  

4.5. `unitOfMeasureId` — `MEAS_DOCS/unit_of_measure`  

4.6. `unitOfMeasureName` — `UNITS_T/short_name`,  
где `UNITS_T/unit_id == MEAS_DOCS/unit_of_measure` из п. 4.5  

4.7. `creator_id` — `MEAS_DOCS/id_creator`  

4.8. `creatorName` — значения из `PERSONS`,  
где `PERSONS/id == id_creator`, найденному в п. 4.7,  
и передать `PERSONS/surname`, `PERSONS/first_name`, `PERSONS/patronymic`  

4.9. `source` — `MEAS_DOCS/source`


# 8. Метод для изменения ДИ

**PATCH** `api/v1/measdocs/{measdocsId}`

**Описание:**  
Данный метод предназначен для редактирования документа измерения.

---

## Входные / выходные параметры

### Входные параметры

| №   | Имя              | Тип    | Обязательное | Описание |
|-----|------------------|--------|--------------|----------|
| 1.1 | measdocsId       | int    | да           | Id документа измерения, которое редактируем |
| 1.2 | text             | string | нет          | Текст ДИ |
| 1.3 | date             | date   | да           | Дата и время создания ДИ |
| 1.4 | availableValueId | int    | нет          |  |
| 1.5 | value            | string | да           | Значение измерения |
| 1.6 | unit_of_measure  | string | да           | Единица измерения |
| 1.7 | creator          | int    |              | Id пользователя, создавшего ДИ |
| 1.8 | source           | string | да           | Источник ДИ |

---

### Выходные параметры

| №   | Имя              | Тип    | Описание |
|-----|------------------|--------|----------|
| 1.1 | id               | int    | Id документа измерения |
| 1.2 | errorDescription | string | Описание ошибки |

---

## Логика метода

При вызове метода выполнять следующую последовательность действий.

1. Проверить заполнение обязательных полей.  
   Если обязательные поля не заполнены, то выводить ошибку  
   **«Заполните обязательные поля»**

2. Проверить, существует ли запись в таблице `MEAS_DOCS`, где  
   `MEAS_DOCS/id == measdocsId`, поданному на вход.  

   Если запись не найдена, то выводить ошибку  
   **«Документ с номером № (n) не найден»**

3. Проверить входное значение `availableValueId`:

   3.1. Если `availableValueId` заполнено, то выполнять п. 4.1 – 4.7  
   (кроме п. 4.4)

   3.2. Если `availableValueId` не заполнено, то выполнять п. 4.1 – 4.7  
   (кроме п. 4.3)

---

В таблицу `MEAS_DOCS` записать следующие значения:

- `date` — сохранить текущую дату на стороне сервера с учетом часового пояса  
- `text` — `null` или передать текст, введенный в поле для ввода  
- `value` — передать входное значение `value`  
- `value` — искать по входному значению `availableValueId` в таблице  
  `CHARACTERISTICS_AVAILABLE_VALUES/value` и передать найденное значение  
- `is_deleted` — `false`  
- `id_creator` — получить значение из токена авторизации  
- `source` — заполняется в зависимости от ресурса:
  - `MOB` — если создано из МП  
  - `WEB` — если создано из WEB

