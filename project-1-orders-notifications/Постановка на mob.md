В этом разделе описаны операции, которые создаются для заказа и выполняются также в мобильном приложении. Каждая операция проходит несколько статусов, взаимодействует с материалами и оборудованием, и может быть поставлена на паузу, отклонена или завершена.

## 1. Выполнение операции с ремонтом

---

### 1.1. Отображение информации по операции

**Методы:**

* `GET /api/v2/statuses`
* `GET /api/v2/orders/{personId}`

**Триггер вызова:**

* Переход из главного меню в раздел «Ремонты»

**Дополнительные методы:**

* `GET /api/v1/persons`

**Триггер вызова доп. методов:**

* При авторизации

#### Входные параметры (query)

| Параметр | Описание                                                                                      |
| -------- | --------------------------------------------------------------------------------------------- |
| personId | ID авторизованного пользователя. Использовать значение `id` из response `GET /api/v1/persons` |

#### Выходные параметры

| Элемент интерфейса                 | Поле из API                     | Условия                                                                                          |
| ---------------------------------- | ------------------------------- | ------------------------------------------------------------------------------------------------ |
| Наименование операции              | operations.shortName            |                                                                                                  |
| Наименование оборудования          | equipmentName                   |                                                                                                  |
| Подробное описание операции        | operations.fullName             |                                                                                                  |
| Требуемый срок выполнения (начало) | operations.startDate            |                                                                                                  |
| Требуемый срок выполнения (конец)  | operations.endDate              |                                                                                                  |
| Код материала                      | materials.materialCode          |                                                                                                  |
| Наименование материала             | materials.materialName          |                                                                                                  |
| Количество материала               | materials.planQuantity          |                                                                                                  |
| Единица измерения                  | materials.unitName              |                                                                                                  |
| Количество материала на складе     | materials.quantity (free_stocs) |                                                                                                  |
| Кнопки «Начать», «Отклонить»       | operations.statusCode           | Отображаются, если `statusCode = OPERATION_PENDING`. Кнопки фиксированы внизу экрана при скролле |

---

### 1.2. Начать операцию

**Метод:**

* `POST /api/v1/operations/start`

Метод изменяет статус выбранной операции на **«В работе»**.

**Триггер вызова:**

* Нажатие кнопки «Начать»

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}` — обновление статуса операции и заказа

#### Входные параметры

| Параметр    | Описание                                                         |
| ----------- | ---------------------------------------------------------------- |
| operationId | ID операции из `operations.id` (`GET /api/v2/orders/{personId}`) |
| personId    | ID пользователя из `GET /api/v1/persons`                         |
| startDate   | Текущая дата и время                                             |

#### Элементы интерфейса

| Элемент                                               | Поле                  | Условия                                             |
| ----------------------------------------------------- | --------------------- | --------------------------------------------------- |
| Кнопки «Завершить», «Отклонить», «Поставить на паузу» | operations.statusCode | Отображаются, если `statusCode = OPERATION_ON_WORK` |

#### Логика работы

1. При нажатии кнопки «Начать» необходимо:
2. Проверить доступ к сети:

##### 2.1. Если доступа нет (офлайн)

1. Отобразить на экране ошибку на 5 секунд: «Интернет-соединение потеряно. Данные сохранены локально и будут автоматически отправлены после его восстановления.»
2. Сохранить запрос в локальной базе
3. Локально изменить статус операции: `statusId = 102`, `statusCode = OPERATION_ON_WORK`
4. Изменить статус операции на «В работе» на плашке операции в списке операций к заказу
5. В карточке операции изменить кнопку «Начать» на «Завершить»
6. В карточке операции в правой верхней части экрана отобразить кнопку «Поставить на паузу»
7. Локально изменить статус заказа на `statusCode = ORDERS_ON_WORK`
8. Изменить статус заказа на «В работе» на плашке заказа
9. Проверять наличие сети, при восстановлении:

   * Вызвать `POST /api/v1/operations/start`
   * Обновить локальные данные через `GET /api/v2/orders/{personId}`

##### 2.2. Если доступ к сети есть (онлайн)

1. Изменить `orders.operations.statusId` на `102`, `statusCode = OPERATION_ON_WORK`
2. Обновить статус операции в списке операций
3. В карточке операции заменить кнопки «Начать» и «Отклонить» на «Завершить» и «Отклонить»
4. В правой верхней части экрана отобразить кнопку «Поставить на паузу»
5. Изменить `orders.statusCode` на `ORDERS_ON_WORK`
6. Обновить статус заказа на плашке

---

### 1.3. Поставить операцию на паузу

**Метод:**

* `POST /api/v1/operations/pause`

Метод изменяет статус операции на **«На паузе»**.

**Триггер вызова:**

* Нажатие кнопки «Поставить на паузу»

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}`

#### Входные параметры

| Параметр       | Тип  | Описание                            |
| -------------- | ---- | ----------------------------------- |
| operationId    | int  | ID операции                         |
| personId       | int  | ID пользователя                     |
| assignmentData | date | Текущая дата                        |
| startDate      | date | Дата и время смены статуса          |
| endDate        | date | Дата и время нажатия кнопки «Пауза» |

#### Элементы интерфейса

| Элемент                          | Поле                  | Условия                                |
| -------------------------------- | --------------------- | -------------------------------------- |
| Кнопки «Отклонить», «Продолжить» | operations.statusCode | Если `statusCode = OPERATION_ON_PAUSE` |

#### Логика

1. При нажатии кнопки «Поставить на паузу» необходимо:
2. Проверить доступ к сети:

##### 2.1. Если доступа нет (офлайн)

1. Отобразить сообщение об ошибке на 5 секунд
2. Сохранить запрос в локальной базе
3. Локально изменить статус операции: `statusId = 103`, `statusCode = OPERATION_ON_PAUSE`
4. Обновить статус операции в списке операций
5. В карточке операции заменить кнопку «Завершить» на кнопку «Продолжить»
6. Скрыть кнопку «Поставить на паузу»
7. Проверять наличие сети, при восстановлении:

   * Вызвать `POST /api/v1/operations/pause`
   * Обновить данные через `GET /api/v2/orders/{personId}`

##### 2.2. Если доступ к сети есть (онлайн)

1. Изменить `operations.statusId` на `103`, `statusCode = OPERATION_ON_PAUSE`
2. Обновить статус операции в списке
3. Изменить `orders.statusCode` на `ORDERS_ON_WORK`
4. В карточке операции заменить кнопку «Завершить» на кнопку «Продолжить`

---

### 1.4. Продолжить операцию

**Метод:**

* `POST /api/v1/operations/continue`

Метод изменяет статус операции на **«В работе»**.

**Триггер вызова:**

* Нажатие кнопки «Продолжить»

#### Входные параметры

| Параметр    | Тип | Описание        |
| ----------- | --- | --------------- |
| operationId | int | ID операции     |
| personId    | int | ID пользователя |

#### Логика

1. При нажатии кнопки «Продолжить» необходимо:
2. Проверить доступ к сети:

##### 2.1. Если доступа нет (офлайн)

1. Отобразить сообщение об ошибке на 5 секунд
2. Сохранить запрос в локальной базе
3. Локально изменить статус операции: `statusId = 102`, `statusCode = OPERATION_ON_WORK`
4. Обновить статус операции в списке операций
5. В карточке операции заменить кнопку «Продолжить» на кнопку «Завершить»
6. Отобразить кнопку «Поставить на паузу»
7. При восстановлении сети:

   * Вызвать `POST /api/v1/operations/continue`
   * Обновить данные через `GET /api/v2/orders/{personId}`

##### 2.2. Если доступ к сети есть (онлайн)

1. Изменить `operations.statusId` на `102`, `statusCode = OPERATION_ON_WORK`
2. Обновить статус операции в списке
3. Отобразить кнопку «Поставить на паузу`

---

### 1.5. Отклонить операцию

**Метод:**

* `POST /api/v1/operations/cancel`

Данный метод изменяет статус выбранной операции задания на **«Отклонена»**.

**Триггер вызова:**

* Нажатие кнопки «Отклонить» на окне для ввода причины отклонения

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}` — обновление статуса операции и заказа

#### Входные параметры

| Параметр       | Тип    | Описание                                    |
| -------------- | ------ | ------------------------------------------- |
| operationId    | int    | ID операции из `operations.id`              |
| personId       | int    | ID пользователя                             |
| assignmentData | date   | Текущая дата                                |
| startDate      | date   | Дата и время смены статуса                  |
| endDate        | date   | Дата и время подтверждения                  |
| comment        | string | Причина отклонения, введённая пользователем |

#### Элементы интерфейса

* Если `statusCode = OPERATION_ON_WORK` — отображаются кнопки «Отклонить» и «Завершить»
* Если `statusCode = OPERATION_ON_PAUSE` — отображаются кнопки «Отклонить» и «Продолжить»

#### Логика работы

1. При нажатии кнопки «Отклонить»:

   * Отобразить окно для ввода причины отклонения
   * Поле причины обязательно для заполнения
   * Кнопка «Отклонить» заблокирована до ввода причины

2. Проверить доступ к сети:

##### 2.1. Если доступа нет (офлайн)

1. Отобразить сообщение об ошибке на 5 секунд
2. Сохранить запрос в локальной базе
3. При подтверждении отклонения:

   * Локально изменить статус операции: `statusId = 109`, `statusCode = OPERATION_CANCELLATION_CONFIRMED`
   * Обновить статус операции на плашке в списке операций
   * В карточке операции скрыть все кнопки
   * Локально изменить статус заказа: `statusCode = ORDERS_DECLINED`
4. Проверять наличие сети, при восстановлении:

   * Вызвать `POST /api/v1/operations/cancel`
   * Обновить данные через `GET /api/v2/orders/{personId}`

##### 2.2. Если доступ к сети есть (онлайн)

1. Изменить `operations.statusId` на `105`, `statusCode = OPERATION_CANCELLATION_CONFIRMED`
2. Обновить статус операции в списке операций
3. В карточке операции скрыть кнопку «Поставить на паузу» (если отображается)
4. Изменить `orders.statusCode` на `ORDERS_DECLINED`
5. Обновить статус заказа на плашке

---

| Параметр | Тип | Описание |
|---------|-----|----------|
| operationId | int | ID операции |
| personId | int | ID пользователя |
| assignmentData | date | Текущая дата |
| startDate | date | Дата и время смены статуса |
| endDate | date | Дата и время подтверждения |
| comment | string | Причина отклонения |


#### Логика

* Причина отклонения обязательна
* Поддерживается офлайн-режим с локальным сохранением и синхронизацией
* После подтверждения все кнопки скрываются

---

### 1.6. Выполнить операцию

**Метод:**

* `POST /api/v1/operations/done`

Данный метод изменяет статус выбранной операции задания на **«Выполнено»**.

**Триггер вызова:**

* Нажатие кнопки «Завершить» в карточке операции

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}` — обновление статуса операции и заказа

#### Входные параметры

| Параметр       | Тип  | Описание                       |
| -------------- | ---- | ------------------------------ |
| operationId    | int  | ID операции из `operations.id` |
| personId       | int  | ID пользователя                |
| assignmentData | date | Текущая дата                   |
| startDate      | date | Дата и время смены статуса     |
| endDate        | date | Дата и время подтверждения     |

#### Элементы интерфейса

* Если `statusCode = OPERATION_ON_WORK` — отображаются кнопки «Завершить» и «Отклонить»

#### Логика работы

1. При нажатии кнопки «Завершить»:
2. Проверить доступ к сети:

##### 2.1. Если доступа нет (офлайн)

1. Отобразить сообщение об ошибке на 5 секунд
2. Сохранить запрос в локальной базе
3. Локально изменить статус операции: `statusId = 108`, `statusCode = OPERATION_COMPLETION_CONFIRMED`
4. Обновить статус операции на плашке в списке операций
5. В карточке операции скрыть все кнопки
6. Если все операции выполнены (`statusId = 108`):

   * Локально изменить статус заказа на `statusCode = ORDERS_COMPLETED`
7. Проверять наличие сети, при восстановлении:

   * Вызвать `POST /api/v1/operations/done`
   * Обновить данные через `GET /api/v2/orders/{personId}`

##### 2.2. Если доступ к сети есть (онлайн)

1. Изменить `operations.statusId` на `104`
2. Обновить статус операции в списке операций
3. Если все операции выполнены:

   * Изменить `orders.statusId` на `4`
   * Обновить статус заказа на плашке

