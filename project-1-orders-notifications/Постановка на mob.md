
## 1. Выполнение операции с ремонтом

---

### 1.1. Отображение информации по операции

**Методы:**

* `GET /api/v2/statuses`
* `GET /api/v2/orders/{personId}`

**Триггер вызова:**

* Переход из главного меню в раздел «Ремонты»

**Дополнительные методы:**

* `GET /api/v1/persons`

**Триггер вызова доп. методов:**

* При авторизации

**Рисунок 22 – Операция с ремонтом**

#### Входные параметры (query)

| Параметр | Описание                                                                                      |
| -------- | --------------------------------------------------------------------------------------------- |
| personId | ID авторизованного пользователя. Использовать значение `id` из response `GET /api/v1/persons` |

#### Выходные параметры

| Элемент интерфейса                 | Поле из API                     | Условия                                                                                          |
| ---------------------------------- | ------------------------------- | ------------------------------------------------------------------------------------------------ |
| Наименование операции              | operations.shortName            |                                                                                                  |
| Наименование оборудования          | equipmentName                   |                                                                                                  |
| Подробное описание операции        | operations.fullName             |                                                                                                  |
| Требуемый срок выполнения (начало) | operations.startDate            |                                                                                                  |
| Требуемый срок выполнения (конец)  | operations.endDate              |                                                                                                  |
| Код материала                      | materials.materialCode          |                                                                                                  |
| Наименование материала             | materials.materialName          |                                                                                                  |
| Количество материала               | materials.planQuantity          |                                                                                                  |
| Единица измерения                  | materials.unitName              |                                                                                                  |
| Количество материала на складе     | materials.quantity (free_stocs) |                                                                                                  |
| Кнопки «Начать», «Отклонить»       | operations.statusCode           | Отображаются, если `statusCode = OPERATION_PENDING`. Кнопки фиксированы внизу экрана при скролле |

---

### 1.2. Начать операцию

**Метод:**

* `POST /api/v1/operations/start`

Метод изменяет статус выбранной операции на **«В работе»**.

**Триггер вызова:**

* Нажатие кнопки «Начать»

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}` — обновление статуса операции и заказа

**Рисунок 23 – Операция в статусе «В работе»**

#### Входные параметры

| Параметр    | Описание                                                         |
| ----------- | ---------------------------------------------------------------- |
| operationId | ID операции из `operations.id` (`GET /api/v2/orders/{personId}`) |
| personId    | ID пользователя из `GET /api/v1/persons`                         |
| startDate   | Текущая дата и время                                             |

#### Элементы интерфейса

| Элемент                                               | Поле                  | Условия                                             |
| ----------------------------------------------------- | --------------------- | --------------------------------------------------- |
| Кнопки «Завершить», «Отклонить», «Поставить на паузу» | operations.statusCode | Отображаются, если `statusCode = OPERATION_ON_WORK` |

#### Логика работы

**1. Проверка доступа к сети**

##### 1.1 Офлайн

* Показать сообщение об ошибке на 5 секунд
* Сохранить запрос локально
* Локально изменить статус операции: `statusId = 102`, `statusCode = OPERATION_ON_WORK`
* Обновить статус операции и заказа в интерфейсе
* Проверять наличие сети и при восстановлении:

  * Вызвать `POST /api/v1/operations/start`
  * Обновить данные через `GET /api/v2/orders/{personId}`

##### 1.2 Онлайн

* Обновить статус операции и заказа через `GET /api/v2/orders/{personId}`
* Обновить кнопки и статусы в интерфейсе

---

### 1.3. Поставить операцию на паузу

**Метод:**

* `POST /api/v1/operations/pause`

Метод изменяет статус операции на **«На паузе»**.

**Триггер вызова:**

* Нажатие кнопки «Поставить на паузу»

**Дополнительные методы:**

* `GET /api/v2/orders/{personId}`

**Рисунок 24 – Операция в статусе «На паузе»**

#### Входные параметры

| Параметр       | Тип  | Описание                            |
| -------------- | ---- | ----------------------------------- |
| operationId    | int  | ID операции                         |
| personId       | int  | ID пользователя                     |
| assignmentData | date | Текущая дата                        |
| startDate      | date | Дата и время смены статуса          |
| endDate        | date | Дата и время нажатия кнопки «Пауза» |

#### Элементы интерфейса

| Элемент                          | Поле                  | Условия                                |
| -------------------------------- | --------------------- | -------------------------------------- |
| Кнопки «Отклонить», «Продолжить» | operations.statusCode | Если `statusCode = OPERATION_ON_PAUSE` |

#### Логика

Аналогична логике обработки офлайн/онлайн сценариев с локальным сохранением данных и последующей синхронизацией.

---

### 1.4. Продолжить операцию

**Метод:**

* `POST /api/v1/operations/continue`

Метод изменяет статус операции на **«В работе»**.

**Триггер вызова:**

* Нажатие кнопки «Продолжить»

**Рисунок 25 – Операция в статусе «В работе»**

#### Входные параметры

| Параметр    | Тип | Описание        |
| ----------- | --- | --------------- |
| operationId | int | ID операции     |
| personId    | int | ID пользователя |

#### Логика

Обработка офлайн и онлайн сценариев с обновлением статусов операции и синхронизацией данных.

---

### 1.5. Отклонить операцию

**Метод:**

* `POST /api/v1/operations/cancel`

Метод изменяет статус операции на **«Отклонена»**.

**Триггер вызова:**

* Нажатие кнопки «Отклонить» после ввода причины

#### Входные параметры

| Параметр       | Тип    | Описание                   |
| -------------- | ------ | -------------------------- |
| operationId    | int    | ID операции                |
| personId       | int    | ID пользователя            |
| assignmentData | date   | Текущая дата               |
| startDate      | date   | Дата и время смены статуса |
| endDate        | date   | Дата и время подтверждения |
| comment        | string | Причина отклонения         |

**Рисунок 26 – Окно ввода причины отклонения**

#### Логика

* Причина отклонения обязательна
* Поддерживается офлайн-режим с локальным сохранением и синхронизацией
* После подтверждения все кнопки скрываются

---

### 1.6. Выполнить операцию

**Метод:**

* `POST /api/v1/operations/done`

Метод изменяет статус операции на **«Выполнено»**.

**Триггер вызова:**

* Нажатие кнопки «Завершить»

#### Входные параметры

| Параметр       | Тип  | Описание                   |
| -------------- | ---- | -------------------------- |
| operationId    | int  | ID операции                |
| personId       | int  | ID пользователя            |
| assignmentData | date | Текущая дата               |
| startDate      | date | Дата и время смены статуса |
| endDate        | date | Дата и время подтверждения |

#### Логика

* Поддержка офлайн-режима
* Локальное изменение статусов
* Автоматическое обновление статуса заказа при выполнении всех операций
