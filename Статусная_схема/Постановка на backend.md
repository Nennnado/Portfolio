# Постановка на бэк: управление статусами задач и заказов

В проекте необходимо реализовать методы для корректного изменения статусов задач и заказов. Все параметры и таблицы приведены в условной форме для конфиденциальности.

---

## Общие сведения

- Проект управляет задачами (`TASKS`) и заказами (`ORDERS`).  
- Проблема текущей реализации: статусы работают нелогично, что приводит к багам и ошибкам в бизнес-процессах.  
- Цель: проанализировать текущую схему статусов (AS IS) и спроектировать корректную схему (TO BE), реализовать методы изменения статусов задач и заказов, подготовить постановку на бэк.

---

## 1. POST /api/v1/tasks/start

**Тип:** POST  
**Описание:** Переводит выбранную задачу в статус «В работе».

### Входные параметры (IMPORT)

| № | Параметр | Тип | Описание | Обязательное |
|---|----------|-----|----------|--------------|
| 1 | taskId   | int | Идентификатор задачи | X |
| 2 | userId   | int | Идентификатор пользователя | X |

### Выходные параметры (EXPORT)

| № | Параметр | Тип | Описание |
|---|----------|-----|----------|
| 1 | errorDescription | string | Текст ошибки (если метод возвращает не 2XX) |

### Алгоритм работы

1. Проверить `taskId` в таблице `TASKS`.  
   - Если запись не найдена — вернуть ошибку в `errorDescription` «Данные отсутствуют в системе».  
2. Проверить статус задачи (`TASKS/status_id`):  
   - Если `system_code == TASK_PENDING`, сменить статус на `TASK_IN_PROGRESS`.  
   - Иначе — вернуть ошибку «Некорректный текущий статус задачи».  
3. Обновить статус заказа (`ORDERS/id_status`) на `ORDER_IN_PROGRESS`.  
4. В таблицу `CONFIRMATIONS` записать:  
   - `id` — идентификатор записи.  
   - `task_id` — `taskId`.  
   - `status_id` — текущий статус задачи.  
   - `executor_id` — соответствующий пользователь из `EXECUTORS`, по `userId` и `assignmentDate`.  
   - `create_date` — текущая дата и время.  
   - `start_date`, `end_date`, `comment` — из входных параметров.  
5. В таблицу `TASKS` обновить поля `actual_start` и `last_resume_time` текущей датой и временем.  
6. Проверить все задачи заказа: если это первая задача (все предыдущие статусы `TASK_CREATED` или `TASK_PENDING`), записать `ORDERS/actual_start` текущую дату.

---

## 2. POST /api/v1/tasks/pause

**Тип:** POST  
**Описание:** Ставит задачу на паузу.

### Входные параметры (IMPORT)

| № | Параметр | Тип | Описание | Обязательное |
|---|----------|-----|----------|--------------|
| 1 | taskId | int | Идентификатор задачи | X |
| 2 | assignmentDate | date | Дата назначения | X |
| 3 | startDate | timestamp | Дата и время вызова метода | X |
| 4 | endDate | timestamp | Дата и время окончания | X |
| 5 | userId | int | Идентификатор пользователя | X |

### Выходные параметры (EXPORT)

| № | Параметр | Тип | Описание |
|---|----------|-----|----------|
| 1 | errorDescription | string | Текст ошибки (если метод возвращает не 2XX) |

### Алгоритм работы

1. Проверить `taskId` в `TASKS`.  
2. Проверить статус задачи:  
   - Если `system_code == TASK_IN_PROGRESS`:  
     - Вычислить `delta = текущая_дата_время - last_resume_time`.  
     - Обновить `actual_duration = actual_duration + delta` (если пусто, считать 0).  
     - Сменить статус на `TASK_ON_PAUSE`.  
   - Иначе — вернуть ошибку «Некорректный текущий статус задачи».  
3. В таблицу `CONFIRMATIONS` записать данные о задаче, пользователе, статусе, времени начала и окончания, комментарий.

---

## 3. POST /api/v1/tasks/continue

**Тип:** POST  
**Описание:** Возвращает задачу в статус «В работе» после паузы.

### Входные параметры (IMPORT)

| № | Параметр | Тип | Описание | Обязательное |
|---|----------|-----|----------|--------------|
| 1 | taskId | int | Идентификатор задачи | X |
| 2 | userId | int | Идентификатор пользователя | X |

### Выходные параметры (EXPORT)

| № | Параметр | Тип | Описание |
|---|----------|-----|----------|
| 1 | errorDescription | string | Текст ошибки (если метод возвращает не 2XX) |

### Алгоритм работы

1. Проверить наличие задачи `taskId`.  
2. Если текущий статус = `TASK_ON_PAUSE`, сменить на `TASK_IN_PROGRESS`.  
3. Обновить поле `last_resume_time` текущей датой и временем.  
4. Записать подтверждение в `CONFIRMATIONS`.

---

## 4. POST /api/v1/tasks/cancel

**Тип:** POST  
**Описание:** Отменяет задачу, переводя её в статус «Отклонено».

### Входные параметры (IMPORT)

| № | Параметр | Тип | Описание | Обязательное |
|---|----------|-----|----------|--------------|
| 1 | taskId | int | Идентификатор задачи | X |
| 2 | assignmentDate | date | Дата назначения | X |
| 3 | startDate | timestamp | Дата и время вызова метода | X |
| 4 | endDate | timestamp | Дата и время окончания | X |
| 5 | userId | int | Идентификатор пользователя | X |
| 6 | comment | string | Причина отклонения | X |

### Выходные параметры (EXPORT)

| № | Параметр | Тип | Описание |
|---|----------|-----|----------|
| 1 | errorDescription | string | Текст ошибки (если метод возвращает не 2XX) |

### Алгоритм работы

1. Проверить наличие задачи `taskId` в `TASKS`.  
2. Определить `requiresApproval` для задачи.  
   - Если `false`, сменить статус на `TASK_CANCELLATION_CONFIRMED`.  
   - Если `true`, сменить на `TASK_DECLINED`.  
3. Если текущий статус = `TASK_IN_PROGRESS`, вычислить `delta` и обновить `actual_duration`.  
4. В таблицу `CONFIRMATIONS` записать все данные (taskId, статус, executor, даты, комментарий).  
5. Проверить статус всех задач в заказе:  
   - Если все отменены, обновить статус заказа (`ORDER_COMPLETED` или `ORDER_DECLINED`).  
   - Если частично отменены, статус заказа не меняется.  
6. Обновить `TASKS/actual_end` текущей датой.  
7. Суммировать `actual_duration` всех задач заказа и записать в `ORDERS/actual_duration`.

---

## 5. POST /api/v1/tasks/done

**Тип:** POST  
**Описание:** Завершает задачу, переводя её в статус «Выполнено».

### Входные параметры (IMPORT)

| № | Параметр | Тип | Описание | Обязательное |
|---|----------|-----|----------|--------------|
| 1 | taskId | int | Идентификатор задачи | X |
| 2 | assignmentDate | date | Дата назначения | X |
| 3 | startDate | timestamp | Дата и время вызова метода | X |
| 4 | endDate | timestamp | Дата и время окончания | X |
| 5 | userId | int | Идентификатор пользователя | X |

### Выходные параметры (EXPORT)

| № | Параметр | Тип | Описание |
|---|----------|-----|----------|
| 1 | errorDescription | string | Текст ошибки (если метод возвращает не 2XX) |

### Алгоритм работы

1. Проверить наличие задачи `taskId` в `TASKS`.  
2. Проверить `operationTypeId`:  
   - Если 1 — продолжить стандартную обработку.  
   - Если 2 — сменить статус на `TASK_COMPLETION_CONFIRMED`, обновить `actual_start` и `actual_end`, присвоить `actual_duration = work_duration`.  
3. Проверить `requiresApproval`:  
   - Если `false`, сменить статус задачи на `TASK_COMPLETION_CONFIRMED`.  
   - Если `true`, сменить на `TASK_COMPLETED`.  
4. В таблицу `CONFIRMATIONS` записать все данные (статус, executor, даты).  
5. Проверить статус всех задач заказа и обновить статус заказа:  
   - Если все задачи завершены, присвоить `ORDER_COMPLETED` или `ORDER_CLOSED`.  
6. Обновить `TASKS/actual_end` текущей датой.  
7. Суммировать `actual_duration` всех задач заказа и записать в `ORDERS/actual_duration`.

---

